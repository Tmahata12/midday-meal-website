<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° - RHS MDM System V2.0</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçΩÔ∏è</text></svg>">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Authentication Module -->
    <script src="auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-role {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .btn-logout {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        /* Container */
        .dashboard-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .action-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .action-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .action-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #666;
            font-weight: 500;
        }

        /* Charts Section */
        .charts-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Recent Activity */
        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .activity-user {
            font-weight: 600;
            color: #667eea;
        }

        .activity-action {
            color: #333;
            margin: 5px 0;
        }

        .activity-time {
            font-size: 0.85rem;
            color: #999;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1>üçΩÔ∏è RHS MDM Dashboard</h1>
                <p>Ramnagar High School - Mid-Day Meal Management System V2.0</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-name">Loading...</div>
                    <div class="user-role">Role</div>
                </div>
                <button class="btn-logout" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-card" onclick="location.href='app.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="action-icon">üçΩÔ∏è</div>
                <div class="action-title" style="color: white;">MDM Application</div>
                <div class="action-desc" style="color: rgba(255,255,255,0.9);">Main management system</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#formC'">
                <div class="action-icon">üìù</div>
                <div class="action-title">Form C Entry</div>
                <div class="action-desc">Daily attendance entry</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#bank'">
                <div class="action-icon">üè¶</div>
                <div class="action-title">Bank Ledger</div>
                <div class="action-desc">Manage transactions</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#rice'">
                <div class="action-icon">üåæ</div>
                <div class="action-title">Rice Ledger</div>
                <div class="action-desc">Stock management</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#reports'">
                <div class="action-icon">üìä</div>
                <div class="action-title">Reports</div>
                <div class="action-desc">View & export reports</div>
            </div>
            <div class="action-card admin-only" onclick="location.href='user-management.html'">
                <div class="action-icon">üë•</div>
                <div class="action-title">Users</div>
                <div class="action-desc">Manage users</div>
            </div>
            <div class="action-card admin-only" onclick="location.href='activity-logs.html'">
                <div class="action-icon">üìã</div>
                <div class="action-title">Activity Logs</div>
                <div class="action-desc">View system logs</div>
            </div>
        </div>

        <!-- Statistics -->
        <h2 class="section-title">üìä Statistics Overview</h2>
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading statistics...</p>
            </div>
        </div>

        <!-- Charts -->
        <h2 class="section-title">üìà Analytics</h2>
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Monthly Expenses</h3>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Attendance Trends</h3>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <h2 class="section-title">üïê Recent Activity</h2>
        <div class="recent-activity" id="recentActivity">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading recent activity...</p>
            </div>
        </div>
    </div>

    <script>
        let expenseChart, attendanceChart;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Wait for auth to initialize
                await authManager.requireAuth();

                // Load statistics
                const stats = await apiCall('/dashboard/stats');
                
                if (stats.success) {
                    displayStatistics(stats.stats);
                    displayRecentActivity(stats.stats.recentActivity);
                    initializeCharts();
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
                authManager.showNotification('Error loading dashboard data', 'error');
            }
        }

        // Display statistics
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value">${stats.formCEntries || 0}</div>
                    <div class="stat-label">Form C Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">‚Çπ${(stats.bankBalance || 0).toLocaleString('en-IN')}</div>
                    <div class="stat-label">Bank Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåæ</div>
                    <div class="stat-value">${(stats.riceStock || 0).toFixed(1)} kg</div>
                    <div class="stat-label">Rice Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíµ</div>
                    <div class="stat-value">‚Çπ${(stats.totalExpenses || 0).toLocaleString('en-IN')}</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                ${authManager.isAdmin() ? `
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value">${stats.users || 0}</div>
                    <div class="stat-label">Active Users</div>
                </div>
                ` : ''}
            `;
        }

        // Display recent activity
        function displayRecentActivity(activities) {
            const activityDiv = document.getElementById('recentActivity');
            
            if (!activities || activities.length === 0) {
                activityDiv.innerHTML = '<p style="text-align: center; color: #999;">No recent activity</p>';
                return;
            }

            activityDiv.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-user">${activity.user?.name || 'Unknown'}</div>
                    <div class="activity-action">${getActivityText(activity)}</div>
                    <div class="activity-time">${formatTime(activity.createdAt)}</div>
                </div>
            `).join('');
        }

        // Get activity text in Bengali
        function getActivityText(activity) {
            const actions = {
                create: '‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                update: '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                delete: '‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßá‡¶õ‡ßá‡¶®',
                login: '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                logout: '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®'
            };

            const modules = {
                formC: 'Form C',
                bank: 'Bank Ledger',
                rice: 'Rice Ledger',
                expense: 'Expense',
                auth: 'Authentication'
            };

            return `${actions[activity.action] || activity.action} ${modules[activity.module] || activity.module}`;
        }

        // Format time
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return `${diff} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ü‡¶ó‡ßá`;
            if (diff < 3600) return `${Math.floor(diff / 60)} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ü‡¶ó‡ßá`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá`;
            return `${Math.floor(diff / 86400)} ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶ó‡ßá`;
        }

        // Initialize charts
        function initializeCharts() {
            // Expense Chart
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(expenseCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Expenses (‚Çπ)',
                        data: [12000, 15000, 13000, 17000, 14000, 16000],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Attendance Chart
            const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(attendanceCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [{
                        label: 'Attendance',
                        data: [450, 470, 465, 480, 475, 460],
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load dashboard on page load
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>
